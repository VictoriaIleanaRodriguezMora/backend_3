# 05 - Seguridad y documentaci√≥n

[PPT](https://docs.google.com/presentation/d/13pXUd0uGHek8fI6TQ7ddgZxX3RxphAq-gbHblmY6J-Q/edit?slide=id.g120b44b0dae_0_606#slide=id.g120b44b0dae_0_606)

# Seguridad

Riesgos mas comunes en nuestras aplicaciones y normas de seguridad.

hardware, f√≠sico, servidor. Pueden

# OWASP - https://owasp.org/

Entidad sin fines de lucro, que intenta que las aplicaciones se desarrollen de la manera m√°s segura posible.
se reunen y auditan aplicaciones con los riesgos m√°s comunes con los que se pueden encontrar y como se pueden enfrentar
desarrollan herramientas para auditar redes, dan charlas.
son una comunidad, una fundacion.

la idea es no solo ser conscientes de c√≥mo escribimos el c√≥digo, c√≥mo perfeccionar nuestra aplicacion, lograr un buen rendimiento, sino que tambien tener en cuenta la seguridad, algo que por ahi no tenemos tan en cuenta, ni tocamos tanto. 

porque bueno, la ciberseguridad es todo un mundo aparte, se puede ser un experto en ciberseguridad, cosa que no va a pasar hoy üòÇ. 

estas organizaciones tratan de concientizar sobre estos peligros a los que estamos expuestos


## Seguridad y documentaci√≥n

### El temor de todo desarrollador‚Ä¶

Si has llegado hasta este curso avanzado, seguramente tienes los conocimientos para desarrollar un servidor backend desde cero mediante buenas pr√°cticas.

Sin embargo, hay algo m√°s de lo que hay que hablar sobre el desarrollo, adem√°s de las arquitecturas, testing y escalabilidad: **las vulnerabilidades**.

Me imagino que en m√°s de una ocasi√≥n habr√°s escuchado hablar sobre el hackeo de X plataforma, sobre el robo de informaci√≥n de X base de datos, o la simple ca√≠da de X p√°gina web debido a alguna persona malintencionada.

Cuando nuestro servidor se encuentre arriba, siempre tendremos este peque√±o cosquilleo:

- ‚Äú¬øY si en alg√∫n momento, a causa de mi sistema web, alguien logra extraer informaci√≥n de mis usuarios?‚Äù
- ‚ÄúNo quiero que sea mi p√°gina web la que comprometa la informaci√≥n sensible de mis clientes‚Äù

---

### ¬øQu√© es una vulnerabilidad?

En el mundo IT, una **vulnerabilidad** es cualquier tipo de debilidad o brecha dejada en nuestro sistema, que permita a una persona malintencionada aprovecharla para comprometer la seguridad del sistema o el usuario.

Existen m√∫ltiples tipos de vulnerabilidades:

- **De hardware**: cuando la implicaci√≥n de seguridad se da en un elemento f√≠sico (como el servidor).
- **De software**: cuando la implicaci√≥n de seguridad se da en nuestro aplicativo.
- **Procedimentales**: cuando la implicaci√≥n de seguridad se da en el proceso mismo de resoluci√≥n.
- **Humanas**: cuando la implicaci√≥n de seguridad se da en una persona o usuario.

Cuando una persona malintencionada encuentra alguna de estas vulnerabilidades, puede tomar acci√≥n para **explotarla** y convertirlo en un evento preocupante.

---

## OWASP

### ¬øQu√© es OWASP?

**OWASP** (Open Web Application Security Project) es un proyecto de c√≥digo abierto internacional, sin fines de lucro, que brinda informaci√≥n referente a la seguridad general de aplicaciones web.

OWASP provee un conjunto de herramientas que permiten conocer a profundidad conceptos y herramientas de seguridad:

- **OWASP ZAP**: Proxy para hacer testing de peticiones entre el navegador y aplicaciones.
- **OWASP Juice Shop**: Aplicativo de prueba con vulnerabilidades, donde existen retos de b√∫squeda y explotaci√≥n.
- **OWASP Testing Guide**: Gu√≠a sobre c√≥mo testear tu aplicaci√≥n web, con un checklist de vulnerabilidades.

---

### OWASP Top 10

Es un documento que muestra las **10 vulnerabilidades principales** y de impacto m√°s cr√≠tico en las aplicaciones web a lo largo de un determinado tiempo. Se actualiza cada 3-4 a√±os.

---

#### A01:2021 ‚Äì Broken Access Control (Control de acceso roto)

Se produce cuando se logra acceder a un recurso al cual no se deber√≠a tener acceso.

**Aplica cuando:**

- Se fuerza una URL para realizar b√∫squedas a otros recursos.
- Un usuario puede seguir navegando a√∫n cuando su token JWT haya expirado.
- Ruptura de una cookie con un token para elevar privilegios.

---

#### A02:2021 ‚Äì Cryptographic Failures (Fallos criptogr√°ficos)

Uso descuidado de procesos criptogr√°ficos, ya sea por aplicaci√≥n err√≥nea o por algoritmos obsoletos.

**Aplica cuando:**

- Se utiliza alg√∫n algoritmo de cifrado obsoleto.
- El proceso de hasheo es intervenido directamente por el desarrollador, generando claves poco s√≥lidas.
- La librer√≠a externa que utilizamos no se actualiza correctamente (relacionado con A06).

---

#### A03:2021 ‚Äì Injection (Inyecci√≥n)

Inserci√≥n de informaci√≥n por parte del usuario con el fin de romper alguna consulta u obtener informaci√≥n sensible.

**Aplica cuando:**

- La data del usuario no fue validada correctamente (ej. `req.body` sin destructurar o validar).
- Un query din√°mico sin validaci√≥n contextual.
- Par√°metros malintencionados para realizar consultas a la base de datos (SQL, NoSQL, etc.).

---

#### A04:2021 ‚Äì Insecure Design (Dise√±o inseguro)

Conjunto de malas pr√°cticas al momento de construir un aplicativo, desde peque√±os detalles hasta elementos estructurales complejos.

**Aplica cuando:**

- Se deja un campo de password en texto plano, sin ocultar.
- Se permite agregar stock con valor `-100`.
- No se aplican patrones de dise√±o correctamente, generando fuerte acoplamiento.

---

#### A05:2021 ‚Äì Security Misconfiguration (Malas configuraciones de seguridad)

Descuidos al configurar el aplicativo, m√≥dulos o servicios en la nube.

**Aplica cuando:**

- Configuramos err√≥neamente elementos de arranque (variables de entorno, argumentos).
- Implementamos permisos o caracter√≠sticas desmedidas (ej. cluster de MongoDB Atlas con IP `0.0.0.0/0`).
- Configuramos mal un cloud service (bucket de AWS S3, ruta de multer).
- Mostramos el stack trace al usuario por mal manejo de errores.

---

#### A06:2021 ‚Äì Vulnerable and Outdated Components (Componentes vulnerables y obsoletos)

Un componente (externo o propio) se vuelve obsoleto o mantiene una vulnerabilidad no subsanada.

**Aplica cuando:**

- No actualizamos librer√≠as con vulnerabilidades reportadas.
- Dejamos m√≥dulos con documentaci√≥n obsoleta o features sin implementar.
- Actualizamos un m√≥dulo sin probar si resolv√≠a la vulnerabilidad inicial.

---

#### A07:2021 ‚Äì Identification and Authentication Failures (Fallos en identificaci√≥n y autenticaci√≥n)

Problemas en el proceso de autenticaci√≥n que permiten forzar accesos o acceder a informaci√≥n mal tratada.

**Aplica cuando:**

- El sistema de login permite rupturas por fuerza bruta.
- Guardamos contrase√±as sin hashear.
- El sistema de ‚Äúcontrase√±a olvidada‚Äù recuerda la contrase√±a en lugar de restablecerla (la p√°gina ten√≠a conocimiento de la contrase√±a todo el tiempo).

---

#### A08:2021 ‚Äì Software and Data Integrity Failures (Fallos de integridad de software y datos)

Uso desmedido de m√≥dulos, librer√≠as o integraciones de fuentes no confiables, o que presentan alguna vulnerabilidad.

**Aplica cuando:**

- Una dependencia o integraci√≥n presenta una falla, dej√°ndonos vulnerables tambi√©n.
- Dependencias que actualizamos sin revisar correctamente (caso Faker.js).
- Procesos CI/CD vulnerados (ej. Heroku + Github con vulnerabilidad de Travis-CI).

---

#### A09:2021 ‚Äì Logging and Monitoring Failures (Fallos de registro y monitoreo)

No tenemos una correcta gesti√≥n de logs y monitoreo del aplicativo.

**Aplica cuando:**

- No hay sistema de monitoreo de APIs para rastrear actividad sospechosa.
- Logs demasiado gen√©ricos que no dan informaci√≥n suficiente para rastrear un error.
- Logs demasiado expl√≠citos que muestran stack trace incluso en producci√≥n.
- Logs solo locales sin posibilidad de exportaci√≥n o filtrado.

---

#### A10:2021 ‚Äì SSRF (Server Side Request Forgery)

La aplicaci√≥n no valida la URL que env√≠a un usuario al acceder a un recurso remoto.

**Aplica cuando:**

- El servidor no tiene control de redirecciones o restricci√≥n de URL por expresi√≥n regular.
- Existe un sistema interno de callbacks que puede desembocar en redirecciones a recursos adicionales.

---

### ¬øQu√© hago con esta informaci√≥n?

El mundo de la seguridad es mucho m√°s amplio que este Top 10. Sin embargo, como desarrolladores podemos aportar un **grano de arena** cultiv√°ndonos en buenas pr√°cticas e implement√°ndolas en nuestros aplicativos.

Para practicar y mejorar tu expertise en seguridad de aplicaciones web, puedes utilizar los proyectos gratuitos de OWASP.

---

‚òï **Break** ‚Äì 10 minutos

---

## Marat√≥n de detecci√≥n de vulnerabilidades

**¬°Es tu turno de ser el analista de vulnerabilidades!**

Te enfrentar√°s a tres proyectos. Todos resuelven el mismo problema, pero aumentan en complejidad. Deber√°s analizar el c√≥digo y la implementaci√≥n para encontrar vulnerabilidades, clasificarlas seg√∫n el OWASP Top 10 y luego discutirlas en grupo.

### ¬øC√≥mo escalan los proyectos?

- **Proyecto 1**: Ruteo, controladores, registro de usuario.
- **Proyecto 2**: Ruteo, controladores, registro de usuario, bases de datos, login de usuario.
- **Proyecto 3**: Ruteo, controladores, registro de usuario, login de usuario, vista de perfil, manejo de sesi√≥n, bases de datos, variables de entorno, permisos.

---

### #FindTheBug (1)

**Duraci√≥n:** 10 minutos (5 individual + 5 grupal)  
Clona el proyecto de aqu√≠ (carpeta: `proyecto1`)

**Principales vulnerabilidades encontradas:**

- **A05 - Security Misconfiguration**: El puerto est√° hardcodeado.
- **A04 - Insecure Design**: El input de password no tiene `type="password"`, se puede visualizar.
- **A04 - Insecure Design**: No se valida el input al guardar usuario, se puede guardar vac√≠o.
- **A04 - Insecure Design**: El patr√≥n por capas no se aplica correctamente; el router de sesi√≥n tiene funcionalidad directa sin controller.
- **A06 - Vulnerable and Outdated Components**: M√≥dulo de FileSystem para usuarios dejado a medio implementar (feature obsoleta).
- **A07 - Identification and Authentication Failures**: El password no se hashea (a pesar de tener bcrypt instalado).

---

### #FindTheBug (2)

**Duraci√≥n:** 15 minutos (10 individual + 5 grupal)  
Clona el proyecto de aqu√≠ (carpeta: `proyecto2`)

**Principales vulnerabilidades encontradas:**

- **A05 - Security Misconfiguration**: Puerto hardcodeado.
- **A05 - Security Misconfiguration**: URL de MongoDB hardcodeada.
- **A04 - Insecure Design**: No se valida correo repetido al registrar usuario.
- **A04 - Insecure Design**: Input de password sin `type="password"`.
- **A09 - Logging and Monitoring Failures**: Al intentar registrar dos usuarios con el mismo correo, la base de datos devuelve error, pero el log es gen√©rico (solo imprime "error").
- **A05 - Security Misconfiguration**: Manejo de errores mal implementado; al enviar un campo vac√≠o en registro, la alerta devuelve success aunque haya error.

> **Nota adicional:** El Dao de Mongo y el Dao de FileSystem no tienen relaci√≥n en el nombre del m√©todo. Si se hizo una migraci√≥n de FileSystem a Mongo, el Dao de FileSystem es un **A06 - Outdated component**. Si la intenci√≥n es usar ambos, es un **A04 - Insecure design** por mal implementaci√≥n del patr√≥n de persistencia.

---

### #FindTheBug (3)

**Duraci√≥n:** 15-20 minutos (10 individual + 5-10 grupal)  
Clona el proyecto de aqu√≠ (carpeta: `proyecto3`)

**Principales vulnerabilidades encontradas:**

- **A05 - Security Misconfiguration**: A pesar de usar dotenv, el secret de JWT no est√° oculto en variables de entorno.
- **A01 - Broken Access Control**: El token de sesi√≥n expira en 30 segundos, pero se puede seguir navegando a la ruta de perfil.
- **A01 - Broken Access Control**: Se puede ver el perfil de otras personas cambiando manualmente la URL.
- **A03 - Injection**: El Dao de usuarios de Mongo recibe par√°metros para dinamizar la b√∫squeda, pero el controlador no valida el query del request, exponiendo datos sensibles.
- **A07 - Identification and Authentication Failures**: El sistema permite n intentos de login sin bloqueo, expuesto a ataques de fuerza bruta.

---

‚òï **Break** ‚Äì 10 minutos

---

## Documentaci√≥n

### ¬øQu√© es documentar?

**Documentar** significa brindar suficiente informaci√≥n sobre alg√∫n proceso, con el fin de que sea lo suficientemente entendible para quien lo lea.

La documentaci√≥n puede darse a nivel simple (comentarios en el c√≥digo) o a nivel m√°s complejo (herramientas de documentaci√≥n para un aplicativo).

### ¬øPor qu√© es importante documentar?

**Caso contextual:**  
Trabajas en una empresa de venta de muebles bajo pedido. Solo hay dos desarrolladores: Mauricio (encargado de gesti√≥n de muebles y compras) y t√∫ (usuarios, CRM, CMS).  
Mauricio renuncia y te quedas con un c√≥digo que no hiciste y del que no tienes conocimiento.  
Te solicitan modificar el proceso de √≥rdenes de venta para agregar √≥rdenes premium.

**Problemas al enfrentarte al c√≥digo:**

- No hay comentarios que gu√≠en.
- No hay recursos que expliquen el flujo o puntos cr√≠ticos.
- No hay ejemplos de input de `salesOrders` ni `purchaseOrders`.

**Conclusi√≥n:**  
Un c√≥digo no documentado es una bomba de tiempo. Dificulta el mantenimiento, incluso para el autor despu√©s de meses.

---

## Swagger

### ¬øQu√© es Swagger?

**Swagger** es una herramienta de documentaci√≥n de c√≥digo que permite mantener cada m√≥dulo de nuestra API dentro de un espectro de entendimiento s√≥lido. Con ella podemos crear nuestra propia **OpenAPI Specification**.

**OpenAPI Specification** (antes conocida como Swagger Specification) es un formato de descripci√≥n de REST APIs, escrito en YAML o JSON. Permite profundizar sobre m√≥dulos, rutas, esquemas, par√°metros, etc.

---

### Proyecto de ejemplo: Adoptme

Adoptme es un proyecto para adopci√≥n de mascotas con las siguientes caracter√≠sticas:

- **Sistema de usuarios**: obtener todos, obtener por id, crear, actualizar, eliminar.
- **Sistema de mascotas**: obtener todas, crear, actualizar, eliminar.
- **Sistema de adopciones**: obtener todas, obtener por id, crear adopci√≥n (usuario + mascota).

Puedes clonar el proyecto [aqu√≠]. No maneja entornos; solo reemplazar la URL de MongoDB en `app.js`.

---

### Instalaci√≥n de Swagger

```bash
npm install swagger-jsdoc swagger-ui-express
```

### Configuraci√≥n inicial

```js
// swaggerOptions.js
const swaggerJsdoc = require("swagger-jsdoc");

const options = {
  definition: {
    openapi: "3.0.0",
    info: {
      title: "API Adoptme",
      description: "Documentaci√≥n de la API para adopci√≥n de mascotas",
      version: "1.0.0",
    },
  },
  apis: ["./docs/**/*.yaml"], // ruta a los archivos de documentaci√≥n
};

const swaggerSpec = swaggerJsdoc(options);
module.exports = swaggerSpec;
```

### conectamos Swagger a Express:

```js
const express = require("express");
const swaggerUi = require("swagger-ui-express");
const swaggerSpec = require("./swaggerOptions");

const app = express();

app.use("/api-docs", swaggerUi.serve, swaggerUi.setup(swaggerSpec));

// ... resto de middlewares y rutas
```

#### La documentaci√≥n m√≠nima debe incluir:

- Schemas
- Routes
- Inputs
- Responses

#### Estructura de carpetas

docs/
users.yaml
pets.yaml
adoptions.yaml

#### Definici√≥n de rutas (paths)

```yml
# docs/users.yaml
paths:
  /api/users/:
    get:
      summary: Obtiene todos los usuarios
      tags:
        - Users
      responses:
        "200":
          description: Lista de usuarios obtenida exitosamente
        "500":
          description: Error interno del servidor
```

#### Try it out

Swagger UI incluye un bot√≥n Try it out que permite ejecutar la petici√≥n directamente desde la interfaz.

#### generando componentes (schemas)

```yml
components:
  schemas:
    User:
      type: object
      properties:
        _id:
          type: string
          description: ID autogenerado de MongoDB
        first_name:
          type: string
          description: Nombre del usuario
        last_name:
          type: string
          description: Apellido del usuario
        email:
          type: string
          description: Correo electr√≥nico
        password:
          type: string
          description: Contrase√±a (hasheada)
      example:
        _id: "60d21b4667d0d8992e610c85"
        first_name: "Juan"
        last_name: "Perez"
        email: "juan@example.com"
        password: "$2b$10$..."
```

#### Referenciar esquemas en respuestas

```yml
paths:
  /api/users/:
    get:
      responses:
        "200":
          description: Lista de usuarios
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
```

#### Par√°metros de ruta

```yml
paths:
  /api/users/{uid}:
    get:
      summary: Obtiene un usuario por ID
      parameters:
        - name: uid
          in: path
          required: true
          description: ID del usuario
          schema:
            type: string
```

#### Definir el req.body (requestBody)

```yml
components:
  requestBodies:
    updateUser:
      description: Objeto con los datos a actualizar
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              first_name:
                type: string
              last_name:
                type: string
              email:
                type: string
```

#### Y luego referenciarlo en el endpoint PUT:

```yml
paths:
  /api/users/{uid}:
    put:
      summary: Actualiza un usuario
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/updateUser"
      responses:
        "200":
          description: Usuario actualizado
```

Objetivo: Documentar en Swagger el proceso de adopci√≥n.

Definir la documentaci√≥n para mascotas (GET y POST).

Definir la documentaci√≥n para el m√©todo register de usuarios (solo registro, no login).

Definir la documentaci√≥n para adopciones (debe recibir doble par√°metro: usuario y mascota).

Corroborar en la base de datos que las entidades se crean correctamente.


00:07:00